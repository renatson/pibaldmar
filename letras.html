<script>
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7lFkME7EB9I5mQkAz3LuzMwL6mDdT4gWBh_rmGhasp-_KoZUkZAW1kF1cqatTDsLUE8yKCV2j7UP_/pub?gid=365269969&single=true&output=csv';

async function fetchCifras() {
    const status = document.getElementById('status');
    const container = document.getElementById('cifras-container');

    try {
        const response = await fetch(CSV_URL, { cache: "no-store" });

        if (!response.ok) {
            throw new Error("Erro ao acessar a planilha");
        }

        const rawData = await response.text();

        if (!rawData || rawData.trim() === "") {
            throw new Error("Planilha vazia");
        }

        const rows = rawData.split(/\r?\n/).filter(r => r.trim() !== "");
        if (rows.length <= 1) {
            status.innerText = "Nenhuma letra encontrada.";
            return;
        }

        const delimiter = rows[0].includes(';') ? ';' : ',';
        container.innerHTML = "";

        for (let i = 1; i < rows.length; i++) {
            const cols = rows[i]
                .split(delimiter)
                .map(c => c.replace(/"/g, '').trim());

            if (cols.length >= 2) {
                const titulo = cols[0];
                const link = cols[1];

                if (!titulo || !link) continue;

                const card = document.createElement('div');
                card.className = 'cifra-card';
                card.style.animation = `reveal 0.4s ease forwards ${i * 0.04}s`;
                card.onclick = () => openViewer(titulo, link);

                card.innerHTML = `
                    <div class="song-info">
                        <div class="icon-box">
                            <i class="ph ph-article-ny-times"></i>
                        </div>
                        <span class="song-title">${titulo}</span>
                    </div>
                    <i class="ph-bold ph-caret-right" style="color: #666;"></i>
                `;

                container.appendChild(card);
            }
        }

        status.style.display = 'none';

    } catch (e) {
        console.error(e);
        status.innerText = "Erro ao carregar as letras. Atualize a p√°gina.";
    }
}

// ---- VISUALIZADOR ----
function openViewer(title, url) {
    document.getElementById('currentTitle').innerText = title;
    const modal = document.getElementById('cifraModal');
    const body = document.getElementById('modalBody');

    let finalUrl = url;
    let fileId = null;

    const match = url.match(/\/d\/(.+?)\/|id=(.+?)(\&|$)/);

    if (match) {
        fileId = match[1] || match[2];
        finalUrl = `https://drive.google.com/file/d/${fileId}/preview`;
    }

    body.innerHTML = `<iframe src="${finalUrl}" allow="autoplay"></iframe>`;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    document.getElementById('cifraModal').style.display = 'none';
    document.getElementById('modalBody').innerHTML = "";
    document.body.style.overflow = 'auto';
}

// ---- FILTRO ----
function filterCifras() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const cards = document.getElementsByClassName('cifra-card');

    for (let card of cards) {
        card.style.display = card.innerText.toLowerCase().includes(input)
            ? "flex"
            : "none";
    }
}

document.addEventListener("DOMContentLoaded", fetchCifras);
</script>
