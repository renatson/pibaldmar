<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSizqPkVTsNhcYVBOOZLtB2DvYCy1BoYvJ7m5JmC1CKYOBnH12hfKfgCy45T3iTAtyy-9ezUaD7zdpf/pub?gid=774324351&single=true&output=csv';
let dateColumnIndex = 0;

async function init() {
    try {
        const response = await fetch(SHEET_URL, { cache: "no-store" });

        if (!response.ok) {
            throw new Error("Erro ao acessar planilha");
        }

        const rawData = await response.text();

        if (!rawData || rawData.trim() === "") {
            throw new Error("Planilha vazia");
        }

        const rows = rawData.split(/\r?\n/).filter(r => r.trim() !== "");
        if (rows.length <= 1) {
            document.getElementById('status').innerHTML = "Nenhum dado encontrado.";
            return;
        }

        const delimiter = rows[0].includes(';') ? ';' : ',';
        const headers = rows[0].split(delimiter).map(h => h.replace(/"/g, '').trim());

        dateColumnIndex = headers.findIndex(h => h.toUpperCase().includes("DATA"));
        if (dateColumnIndex === -1) dateColumnIndex = 0;

        document.getElementById('tableHead').innerHTML =
            `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

        let bodyHtml = '';
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].split(delimiter);
            if (cells.length >= headers.length) {
                bodyHtml += `<tr>${cells.map(c => `<td>${c.replace(/"/g, '')}</td>`).join('')}</tr>`;
            }
        }

        document.getElementById('tableBody').innerHTML = bodyHtml;
        document.getElementById('status').style.display = 'none';
        document.getElementById('escalaTable').style.display = 'table';

        highlightNextScale();
    } catch (e) {
        document.getElementById('status').innerHTML =
            "Erro ao carregar dados. Tente atualizar a p√°gina.";
        console.error(e);
    }
}

document.addEventListener("DOMContentLoaded", init);
</script>
